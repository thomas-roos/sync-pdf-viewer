<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT Synchronized PDF Viewer</title>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .mqtt-status {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-indicator.connected {
            background-color: #28a745;
        }
        
        .status-indicator.disconnected {
            background-color: #dc3545;
        }
        
        .status-indicator.connecting {
            background-color: #ffc107;
        }
        
        input, select, button {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .device-config {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .pdf-container {
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            height: 70vh;
        }
        
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .mqtt-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MQTT Synchronized PDF Viewer</h1>
        
        <!-- MQTT Connection Status -->
        <div class="mqtt-status">
            <div id="statusIndicator" class="status-indicator disconnected"></div>
            <span id="connectionStatus">Disconnected</span>
        </div>
        
        <!-- MQTT Configuration -->
        <div class="controls">
            <h3>MQTT Configuration</h3>
            <div class="mqtt-config">
                <input type="text" id="mqttEndpoint" placeholder="IoT Core Endpoint" 
                       value="your-iot-endpoint.iot.us-east-1.amazonaws.com">
                <input type="text" id="mqttTopic" placeholder="MQTT Topic" value="pdf-sync/folder-selection">
                <input type="text" id="clientId" placeholder="Client ID" value="">
                <input type="text" id="accessKey" placeholder="AWS Access Key">
                <input type="password" id="secretKey" placeholder="AWS Secret Key">
                <select id="awsRegion">
                    <option value="us-east-1">US East (N. Virginia)</option>
                    <option value="us-west-2">US West (Oregon)</option>
                    <option value="eu-west-1">Europe (Ireland)</option>
                    <option value="ap-southeast-1">Asia Pacific (Singapore)</option>
                </select>
            </div>
            <button id="connectBtn" onclick="toggleMqttConnection()">Connect to MQTT</button>
        </div>
        
        <!-- Device Configuration -->
        <div class="device-config">
            <h3>Device Configuration</h3>
            <label for="deviceName">Device Name:</label>
            <input type="text" id="deviceName" placeholder="e.g., Mobile-1, Tablet-A" value="">
            
            <label for="localFolder">Local PDF Folder:</label>
            <select id="localFolder">
                <option value="">-- Select Local Folder --</option>
                <option value="mobile1">Mobile 1 Folder</option>
                <option value="mobile2">Mobile 2 Folder</option>
                <option value="tablet1">Tablet 1 Folder</option>
                <option value="desktop">Desktop Folder</option>
                <option value="backup">Backup Folder</option>
            </select>
        </div>
        
        <!-- PDF Controls -->
        <div class="controls">
            <h3>PDF Control</h3>
            <input type="text" id="pdfFileName" placeholder="PDF filename from server" value="">
            <button id="publishBtn" onclick="publishPdfSelection()" disabled>Publish PDF Selection</button>
            <button onclick="loadCurrentPdf()">Load Current PDF</button>
        </div>
        
        <div id="status" class="status" style="display: none;"></div>
        
        <!-- PDF Viewer -->
        <div class="pdf-container">
            <iframe id="pdfViewer" src="about:blank"></iframe>
        </div>
    </div>

    <script>
        let mqttClient = null;
        let isConnected = false;
        let currentPdfName = '';
        
        // Generate unique client ID
        document.getElementById('clientId').value = 'pdf-viewer-' + Math.random().toString(36).substr(2, 9);
        
        // Set device name based on user agent
        const deviceName = /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 
            'Mobile-' + Math.random().toString(36).substr(2, 3) : 
            'Desktop-' + Math.random().toString(36).substr(2, 3);
        document.getElementById('deviceName').value = deviceName;
        
        function toggleMqttConnection() {
            if (isConnected) {
                disconnectMqtt();
            } else {
                connectMqtt();
            }
        }
        
        function connectMqtt() {
            const endpoint = document.getElementById('mqttEndpoint').value;
            const accessKey = document.getElementById('accessKey').value;
            const secretKey = document.getElementById('secretKey').value;
            const region = document.getElementById('awsRegion').value;
            const clientId = document.getElementById('clientId').value;
            
            if (!endpoint || !accessKey || !secretKey) {
                showStatus('Please fill in all MQTT connection details', 'error');
                return;
            }
            
            updateConnectionStatus('connecting', 'Connecting...');
            
            // AWS IoT Core WebSocket URL
            const protocol = 'wss';
            const url = `${protocol}://${endpoint}/mqtt`;
            
            try {
                // For production, you should use AWS Cognito or IAM roles for authentication
                // This is a simplified example - consider security best practices
                mqttClient = mqtt.connect(url, {
                    clientId: clientId,
                    username: accessKey,
                    password: secretKey,
                    protocol: 'wss',
                    port: 443,
                    clean: true,
                    reconnectPeriod: 5000,
                    connectTimeout: 30000
                });
                
                mqttClient.on('connect', function() {
                    isConnected = true;
                    updateConnectionStatus('connected', 'Connected');
                    document.getElementById('connectBtn').textContent = 'Disconnect';
                    document.getElementById('publishBtn').disabled = false;
                    
                    // Subscribe to the PDF sync topic
                    const topic = document.getElementById('mqttTopic').value;
                    mqttClient.subscribe(topic, function(err) {
                        if (err) {
                            showStatus('Failed to subscribe to topic: ' + err.message, 'error');
                        } else {
                            showStatus('Successfully subscribed to: ' + topic, 'success');
                        }
                    });
                });
                
                mqttClient.on('message', function(topic, message) {
                    handleMqttMessage(topic, message.toString());
                });
                
                mqttClient.on('error', function(error) {
                    showStatus('MQTT Error: ' + error.message, 'error');
                    updateConnectionStatus('disconnected', 'Error: ' + error.message);
                });
                
                mqttClient.on('close', function() {
                    isConnected = false;
                    updateConnectionStatus('disconnected', 'Disconnected');
                    document.getElementById('connectBtn').textContent = 'Connect to MQTT';
                    document.getElementById('publishBtn').disabled = true;
                });
                
            } catch (error) {
                showStatus('Connection failed: ' + error.message, 'error');
                updateConnectionStatus('disconnected', 'Connection failed');
            }
        }
        
        function disconnectMqtt() {
            if (mqttClient) {
                mqttClient.end();
                mqttClient = null;
            }
        }
        
        function handleMqttMessage(topic, message) {
            try {
                const data = JSON.parse(message);
                
                if (data.pdfName) {
                    currentPdfName = data.pdfName;
                    document.getElementById('pdfFileName').value = data.pdfName;
                    
                    showStatus(`Received PDF selection: ${data.pdfName} from ${data.deviceName || 'unknown device'}`, 'info');
                    
                    // Auto-load the PDF if local folder is selected
                    const localFolder = document.getElementById('localFolder').value;
                    if (localFolder) {
                        loadCurrentPdf();
                    }
                }
                
            } catch (error) {
                showStatus('Failed to parse MQTT message: ' + error.message, 'error');
            }
        }
        
        function publishPdfSelection() {
            if (!isConnected || !mqttClient) {
                showStatus('Not connected to MQTT', 'error');
                return;
            }
            
            const pdfName = document.getElementById('pdfFileName').value;
            const deviceName = document.getElementById('deviceName').value;
            const topic = document.getElementById('mqttTopic').value;
            
            if (!pdfName) {
                showStatus('Please enter a PDF filename', 'error');
                return;
            }
            
            const message = {
                pdfName: pdfName,
                deviceName: deviceName,
                timestamp: new Date().toISOString()
            };
            
            mqttClient.publish(topic, JSON.stringify(message), function(err) {
                if (err) {
                    showStatus('Failed to publish: ' + err.message, 'error');
                } else {
                    showStatus(`Published PDF selection: ${pdfName}`, 'success');
                    currentPdfName = pdfName;
                }
            });
        }
        
        function loadCurrentPdf() {
            const localFolder = document.getElementById('localFolder').value;
            const pdfName = document.getElementById('pdfFileName').value || currentPdfName;
            
            if (!localFolder) {
                showStatus('Please select a local folder', 'error');
                return;
            }
            
            if (!pdfName) {
                showStatus('No PDF filename specified', 'error');
                return;
            }
            
            const pdfPath = `${localFolder}/${pdfName}`;
            const pdfViewer = document.getElementById('pdfViewer');
            
            showStatus(`Loading ${pdfName} from ${localFolder}...`, 'info');
            
            pdfViewer.onload = function() {
                showStatus(`Successfully loaded: ${pdfName}`, 'success');
            };
            
            pdfViewer.onerror = function() {
                showStatus(`Error loading: ${pdfPath}`, 'error');
            };
            
            pdfViewer.src = pdfPath;
        }
        
        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('connectionStatus');
            
            indicator.className = `status-indicator ${status}`;
            statusText.textContent = message;
        }
        
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            showStatus('Configure MQTT settings and connect to start syncing', 'info');
        });
        
        // Auto-load PDF when filename changes
        document.getElementById('pdfFileName').addEventListener('input', function() {
            if (this.value && document.getElementById('localFolder').value) {
                setTimeout(loadCurrentPdf, 500); // Small delay for better UX
            }
        });
    </script>
</body>
</html>
